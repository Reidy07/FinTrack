﻿@using Microsoft.AspNetCore.Identity
@using FinTrack.Infrastructure.Identity
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

@model FinTrack.Core.DTOs.DashboardSummaryDto
@using System.Text.Json
@{
    ViewData["Title"] = "Dashboard";

    // Para obtener el nombre del usuario:
    var user = await UserManager.GetUserAsync(User);
    var firstName = user?.FirstName ?? User.Identity.Name;

    var labelsJson = JsonSerializer.Serialize(Model?.ChartLabels ?? new List<string>());
    var incomeJson = JsonSerializer.Serialize(Model?.ChartIncomeData ?? new List<decimal>());
    var expenseJson = JsonSerializer.Serialize(Model?.ChartExpenseData ?? new List<decimal>());
}

<div class="ft-page">
    <div class="ft-header">
        <div>
            <div class="ft-header-title">¡Bienvenido, @firstName!</div>
            <div class="ft-header-sub">@DateTime.Now.ToString("dddd, dd 'de' MMMM 'de' yyyy")</div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="ft-kpi">
            <div class="ft-kpi-title">Ingresos (mes)</div>
            <div class="ft-kpi-value">@((Model?.TotalIncome ?? 0m).ToString("C"))</div>
        </div>
        <div class="ft-kpi">
            <div class="ft-kpi-title">Gastos (mes)</div>
            <div class="ft-kpi-value">@((Model?.TotalExpenses ?? 0m).ToString("C"))</div>
        </div>
        <div class="ft-kpi">
            <div class="ft-kpi-title">Balance</div>
            <div class="ft-kpi-value">@((Model?.Balance ?? 0m).ToString("C"))</div>
        </div>
    </div>

    <section class="ft-section mt-4">
        <div class="h-[320px]">
            <canvas id="dashboardChart"></canvas>
        </div>
    </section>
</div>
<script id="dashboard-chart-data" type="application/json">
    @Html.Raw(JsonSerializer.Serialize(new {
        labels = Model?.ChartLabels ?? new List<string>(),
                income = Model?.ChartIncomeData ?? new List<decimal>(),
                expense = Model?.ChartExpenseData ?? new List<decimal>()
        }))
</script>
@section Scripts {
    <script>
        const ctx = document.getElementById('dashboardChart');
        if (ctx) {
        const raw = document.getElementById('dashboard-chart-data')?.textContent ?? "{}";
        const data = JSON.parse(raw);

        const labels = Array.isArray(data.labels) ? data.labels : [];
        const incomeData = Array.isArray(data.income) ? data.income : [];
        const expenseData = Array.isArray(data.expense) ? data.expense : [];


            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.length ? labels : ['—'],
                    datasets: [
                        { label: 'Ingresos', data: incomeData.length ? incomeData : [0], tension: 0.35 },
                        { label: 'Gastos', data: expenseData.length ? expenseData : [0], tension: 0.35 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    </script>
}
