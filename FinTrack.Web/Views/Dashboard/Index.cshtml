@using Microsoft.AspNetCore.Identity
@using FinTrack.Infrastructure.Identity

@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

@model FinTrack.Core.DTOs.DashboardSummaryDto

@{
    ViewData["Title"] = "Dashboard";
}

<!-- Topbar integrado -->
<div class="d-flex justify-content-between align-items-end mb-4">
    <div>
        @if (SignInManager.IsSignedIn(User))
        {
            /* --- MODO LOGUEADO: SIDEBAR + CONTENIDO --- */

            // Obtenemos el usuario para mostrar su nombre o inicial
            var user = await UserManager.GetUserAsync(User);
            var userName = user?.FirstName ?? @user.FirstName!;

        
        <h2 class="mb-0">Bienvenido, @user.FirstName!</h2> <!-- Aquí puedes poner el nombre real si lo tienes en ViewBag -->
        <p class="text-muted mb-0">@DateTime.Now.ToString("dddd, dd 'de' MMMM 'de' yyyy")</p>
        }
    </div>
    <div class="position-relative">
        <i class="bi bi-bell text-muted fs-4"></i>
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.6rem;">
            3
        </span>
    </div>
</div>

<h4 class="mb-3">Dashboard</h4>
<p class="text-muted">Gestión y análisis financiero</p>

<!-- Tarjetas Resumen -->
<div class="row g-4 mb-4">
    <!-- Ingresos -->
    <div class="col-md-4">
        <div class="card h-100 p-3">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <span class="text-muted">Ingresos (mes)</span>
                <div class="bg-dark p-2 rounded">
                    <i class="bi bi-graph-up-arrow text-success"></i>
                </div>
            </div>
            <h2 class="mb-1 text-light">@Model.TotalIncome.ToString("C0")</h2>
            <small class="text-muted">Vs. mes anterior: <span class="text-danger">0%</span></small>
        </div>
    </div>

    <!-- Gastos -->
    <div class="col-md-4">
        <div class="card h-100 p-3">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <span class="text-muted">Gastos (mes)</span>
                <div class="bg-danger bg-opacity-25 p-2 rounded">
                    <i class="bi bi-graph-down-arrow text-danger"></i>
                </div>
            </div>
            <h2 class="mb-1 text-light">@Model.TotalExpenses.ToString("C0")</h2>
            <small class="text-muted">Vs. mes anterior: <span class="text-success">0%</span></small>
        </div>
    </div>

    <!-- Balance -->
    <div class="col-md-4">
        <div class="card h-100 p-3">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <span class="text-muted">Balance</span>
                <div class="bg-success bg-opacity-25 p-2 rounded">
                    <i class="bi bi-wallet2 text-success"></i>
                </div>
            </div>
            <h2 class="mb-1 text-light">@Model.Balance.ToString("C0")</h2>
            <small class="text-muted">Ahorro estimado</small>
        </div>
    </div>
</div>

<!-- Gráficos y Alertas -->
<div class="row g-4">
    <!-- Gráfico Principal (Ocupa 2/3) -->
    <div class="col-lg-8">
        <div class="card p-4 h-100">
            <h5 class="mb-1">Tendencia mensual</h5>
            <p class="text-muted small mb-4">Ingresos vs gastos (últimos 6 meses)</p>

            <div style="height: 300px;">
                <canvas id="dashboardChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Alertas (Ocupa 1/3) -->
    <div class="col-lg-4">
        <div class="card p-4 h-100">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="mb-0 text-light">Alertas</h5>
                <a href="#" class="text-primary small">Ver todas</a>
            </div>

            <!-- Lista de Alertas -->
            <div class="d-flex flex-column gap-3">
                <!-- Alerta 1 (Roja) -->
                <div class="card p-3 border-danger border bg-danger bg-opacity-10">
                    <div class="d-flex justify-content-between">
                        <span class="fw-bold text-danger small">Presupuesto excedido</span>
                        <span class="text-muted small">Hoy</span>
                    </div>
                    <p class="mb-0 text-muted small mt-1">Gastos superan el límite mensual</p>
                </div>

                <!-- Alerta 2 (Normal) -->
                <div class="card p-3">
                    <div class="d-flex justify-content-between">
                        <span class="fw-bold text-white small">Gasto inusual</span>
                        <span class="text-muted small">Ayer</span>
                    </div>
                    <p class="mb-0 text-muted small mt-1">Transporte salió 80% más esta semana</p>
                </div>

                <!-- Alerta 3 (Normal) -->
                <div class="card p-3">
                    <div class="d-flex justify-content-between">
                        <span class="fw-bold text-white small">Proyección</span>
                        <span class="text-muted small">Ayer</span>
                    </div>
                    <p class="mb-0 text-muted small mt-1">Podrás ahorrar el mes con +$320</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Configuración Chart.js para que se vea como en Figma (Curvas suaves y colores neón)
        var ctx = document.getElementById('dashboardChart').getContext('2d');

        // Gradiente para la línea verde
        var gradientGreen = ctx.createLinearGradient(0, 0, 0, 400);
        gradientGreen.addColorStop(0, 'rgba(16, 185, 129, 0.2)');
        gradientGreen.addColorStop(1, 'rgba(16, 185, 129, 0)');

        var myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Sep', 'Oct', 'Nov', 'Dic', 'Ene', 'Feb'],
                datasets: [
                    {
                        label: 'Ingresos',
                        data: [1800, 500, 2600, 2100, 4000, 2100], // Datos fake para demo
                        borderColor: '#10B981', // Verde
                        backgroundColor: gradientGreen,
                        tension: 0.4, // Curva suave
                        fill: true,
                        pointRadius: 4,
                        pointBackgroundColor: '#0B0E14',
                        pointBorderColor: '#10B981',
                        borderWidth: 2
                    },
                    {
                        label: 'Gastos',
                        data: [800, 600, 700, 600, 200, 250], // Datos fake
                        borderColor: '#EF4444', // Rojo
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: '#0B0E14',
                        pointBorderColor: '#EF4444',
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#9CA3AF', usePointStyle: true, boxWidth: 6 }
                    }
                },
                scales: {
                    y: {
                        grid: { color: '#2D3748', borderDash: [5, 5] },
                        ticks: { color: '#9CA3AF' },
                        beginAtZero: true
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: '#9CA3AF' }
                    }
                }
            }
        });
    </script>
}
