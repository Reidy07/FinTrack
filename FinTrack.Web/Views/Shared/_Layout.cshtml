@using Microsoft.AspNetCore.Identity
@using FinTrack.Infrastructure.Identity

@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - FinTrack</title>

    <link rel="icon" type="image/svg+xml" href="~/logo.svg" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
</head>

<body class="min-h-full bg-[#070A12] text-white">
    @if (SignInManager.IsSignedIn(User))
    {
        var user = await UserManager.GetUserAsync(User);
        var userName = user?.FirstName ?? User.Identity?.Name ?? "Usuario";

        <div class="min-h-screen lg:flex">
            <!-- MOBILE TOPBAR -->
            <header class="lg:hidden sticky top-0 z-20 px-4 py-3 bg-black/20 border-b border-white/10 backdrop-blur">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="h-9 w-9 rounded-xl bg-emerald-400 flex items-center justify-center">
                            <a asp-controller="Dashboard" asp-action="Index" class="flex items-center gap-3 px-3 py-3">
                                <img src="~/images/fintrack-logo.jpg" asp-append-version="true"
                                     class="h-9 w-9 rounded-xl border border-white/10 bg-white/[0.04] p-2"
                                     alt="FinTrack" />
                                <div class="font-semibold text-white/90">FinTrack</div>
                            </a>

                        </div>

                        <div class="leading-tight">
                            <div class="font-semibold">FinTrack</div>
                            <div class="text-xs text-white/50">Personal Finance</div>
                        </div>
                    </div>

                    <!-- simple placeholder icons (menu drawer lo hacemos después si quieres) -->
                    <div class="flex items-center gap-3">
                        <a asp-controller="Alerts" asp-action="Index"
                           class="h-10 w-10 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center hover:bg-white/10 transition"
                           title="Alertas">
                            <i class="bi bi-bell"></i>
                        </a>
                    </div>
                </div>
            </header>

            <!-- SIDEBAR (DESKTOP) -->
            <aside class="hidden lg:block w-[290px] shrink-0 px-5 py-6">
                <div class="ft-surface h-full p-5 flex flex-col">
                    <!-- Logo -->
                    <div class="mb-6 flex items-center gap-3">
                        <div class="h-10 w-10 rounded-xl bg-emerald-400 flex items-center justify-center">
                            <partial name="_Brand" />
                        </div>
                        <div class="leading-tight">
                            <div class="font-semibold">FinTrack</div>
                            <div class="text-xs text-white/50">Personal Finance</div>
                        </div>
                    </div>

                    <!-- Menú -->
                    <div class="flex-1 overflow-auto pr-1">
                        <partial name="_Sidebar" />
                    </div>

                    <!-- Perfil + Logout -->
                    <div class="mt-6 border-t border-white/10 pt-4">
                        <a asp-area="Identity" asp-page="/Account/Manage/Index"
                           class="flex items-center gap-3 rounded-xl p-2 hover:bg-white/5 transition">
                            <div class="h-10 w-10 rounded-full bg-white/10 flex items-center justify-center font-semibold">
                                @userName.Substring(0, 1).ToUpper()
                            </div>
                            <div class="leading-tight">
                                <div class="text-sm font-semibold">@userName</div>
                                <div class="text-xs text-white/50">Ver perfil</div>
                            </div>
                        </a>

                        <form asp-area="Identity" asp-page="/Account/Logout"
                              asp-route-returnUrl="@Url.Action("Index", "Dashboard", new { area = "" })"
                              class="mt-3">
                            <button type="submit"
                                    class="w-full text-left flex items-center gap-2 rounded-xl p-2 text-red-400 hover:bg-red-500/10 transition">
                                <i class="bi bi-box-arrow-right"></i>
                                <span class="text-sm">Cerrar sesión</span>
                            </button>
                        </form>
                    </div>
                </div>
            </aside>

            <!-- MAIN -->
            <main class="flex-1 p-4 sm:p-6 lg:p-8">
                <div class="ft-surface p-4 sm:p-6 min-h-[calc(100vh-2rem)]">
                    @RenderBody()
                </div>
            </main>
        </div>
    }
    else
    {
        <!-- NOT LOGGED IN (Login/Register/Identity) -->
        <main class="min-h-screen flex items-center justify-center p-6">
            <div class="ft-surface p-6 sm:p-8 w-full max-w-md">
                @RenderBody()
            </div>
        </main>
    }

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    @RenderSection("Scripts", required: false)
</body>
</html>
